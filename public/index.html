<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Gerador PIX - PUSHIN PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#2f2f2f;
      --blue:#0aff2b;
      --blue-hover:#afff1a;
      --blue-press:#06c750;
      --white:#ffffff;
      --muted:#9bffb9;
      --red:#ff3b3b;
      --red-hover:#ff5555;
      --red-press:#c72020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--white);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      display:flex;align-items:center;justify-content:center;
    }
    .wrap{width:100%;max-width:960px;padding:40px 20px 56px;text-align:center;position:relative}
    .title{font-size:clamp(28px,6vw,64px);font-weight:900;margin:0}
    .subtitle{font-size:clamp(16px,3vw,36px);font-weight:700;color:var(--blue);margin:8px 0 28px}
    .grid{display:flex;flex-wrap:wrap;justify-content:center;gap:22px;margin:34px auto 16px;max-width:740px}
    .chip{
      display:inline-flex;align-items:center;justify-content:center;width:90px;height:72px;border-radius:20px;
      background:var(--blue);color:#fff;font-weight:900;font-size:32px;border:none;cursor:pointer;
      box-shadow:0 8px 20px rgba(10,255,51,.35);
      transition:transform .05s, background .15s, box-shadow .15s;user-select:none
    }
    .chip:hover{background:var(--blue-hover);box-shadow:0 10px 24px rgba(30,255,10,.45)}
    .chip:active{transform:translateY(1px);background:var(--blue-press)}
    .form{
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:6px 0 10px
    }
    .input{
      text-align:center;font-size:1.3rem;font-weight:700;color:#161616;background:#fff;
      border-radius:12px;border:none;padding:12px 18px;width:320px;max-width:90%;
      outline:4px solid transparent; transition:outline .15s
    }
    .input:focus{outline:4px solid #ffffff55}
    .btn{
      background:var(--blue);color:#000;font-weight:900;border:none;border-radius:10px;
      padding:12px 20px;font-size:1.05rem;cursor:pointer;box-shadow:0 6px 14px rgba(10,255,112,.3)
    }
    .btn:hover{background:var(--blue-hover)}
    .btn:active{background:var(--blue-press)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .qr{width:220px;height:220px;border-radius:14px;margin:28px auto 10px;display:none;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.95rem;line-height:1.25rem;
      background:#00000022;color:#e9eefc;border-radius:10px;padding:10px;margin:12px auto 0;max-width:720px;
      word-break:break-all;text-align:left;display:none}
    .status{margin-top:12px;font-size:1.05rem;color:var(--muted);font-weight:700;min-height:1.4em}
    .copy-btn{
      margin-top:10px;background:var(--blue);border:none;border-radius:10px;color:#000;font-weight:900;
      padding:10px 16px;font-size:1rem;cursor:pointer;box-shadow:0 6px 14px rgba(10,255,112,.3);display:none
    }
    .copy-btn:hover{background:var(--blue-hover)}
    .copy-btn:active{background:var(--blue-press)}
    #close-btn{
      position:absolute;top:10px;right:18px;background:var(--red);color:#fff;font-size:.9rem;font-weight:600;
      border:none;border-radius:8px;padding:8px 14px;cursor:pointer;z-index:10;transition:background .2s, transform .1s
    }
    #close-btn:hover{background:var(--red-hover)}
    #close-btn:active{background:var(--red-press);transform:scale(.96)}
  </style>
</head>
<body>
  <div class="wrap">
    <button id="close-btn">FECHAR ABA</button>
    <h1 class="title">GERADOR PIX</h1>
    <div class="subtitle">PUSHIN PAY - TEX</div>

    <div class="grid" id="amountGrid">
      <button class="chip" data-amount="10">10</button>
      <button class="chip" data-amount="15">15</button>
      <button class="chip" data-amount="20">20</button>
      <button class="chip" data-amount="25">25</button>
      <button class="chip" data-amount="30">30</button>
      <button class="chip" data-amount="35">35</button>
      <button class="chip" data-amount="40">40</button>
      <button class="chip" data-amount="45">45</button>
      <button class="chip" data-amount="50">50</button>
    </div>

    <!-- FORM ÚNICO COM MÁSCARA BRL -->
    <form id="checkoutForm" class="form" autocomplete="off">
      <input id="amount" class="input" type="text" inputmode="numeric"
             placeholder="R$ 0,00" aria-label="Valor em reais" />
      <button id="btn" class="btn" type="submit">Gerar QR</button>
    </form>

    <img id="qr" class="qr" alt="QR Code">
    <div id="emv" class="mono"></div>
    <div id="status" class="status"></div>
    <button id="copyBtn" class="copy-btn">COPIAR CHAVE</button>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    let currentId = null, lastCheck = 0;

    // ====== MÁSCARA BRL ======
    const brlf = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

    // Texto -> centavos (mantém só dígitos)
    const toCents = (str) => {
      const digits = (str || '').replace(/\D/g, '');
      return digits ? parseInt(digits, 10) : 0;
    };
    // Aplica máscara a partir de centavos
    const setMasked = (cents) => {
      $('#amount').dataset.cents = String(cents);
      $('#amount').value = cents ? brlf.format(cents / 100) : '';
    };

    // Máscara ao digitar/colar/focar
    $('#amount').addEventListener('input', (e) => setMasked(toCents(e.target.value)));
    $('#amount').addEventListener('focus', () => { if (!$('#amount').value) setMasked(0); });
    window.addEventListener('load', () => $('#amount').focus());

    // ====== FECHAR ABA ======
    $('#close-btn').onclick = () => {
      window.close();
      setTimeout(() => { if (!window.closed) alert('Por segurança do navegador, feche esta aba manualmente.'); }, 300);
    };

    // ====== CHIPS PRÉ-DEFINIDOS ======
    document.getElementById('amountGrid').addEventListener('click', e => {
      const b = e.target.closest('.chip');
      if (!b) return;
      const cents = Math.round(parseFloat(b.dataset.amount) * 100);
      setMasked(cents);
      createCharge((cents/100).toFixed(2));
    });

    // ====== SUBMIT DO FORM ======
    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const cents = parseInt($('#amount').dataset.cents || '0', 10);
      const valor = cents / 100;
      if (!valor || isNaN(valor) || valor < 0.5) {
        $("#status").textContent = "Insira um valor válido (mínimo R$ 0,50)";
        return;
      }
      createCharge(valor.toFixed(2));
    });

    // ====== REQUISIÇÃO PARA O BACKEND ======
    async function createCharge(amount){
      setUI({loading:true});
      try{
        const r = await fetch("/api/pix", {
          method:"POST",
          headers:{"content-type":"application/json"},
          body:JSON.stringify({ amountBRL: Number(amount) }) // <-- envia número
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.detail?.message || j.error || "Falha ao gerar cobrança");

        currentId = j.id || j.transaction_id || j.uuid || j.data?.id || null;
        const emv = j.copyPaste || j.emv || j.emvPayload || j.payload || j.data?.copyPaste || "";
        const qrImg = j.pngBase64 || j.qr_code || j.qrcode || j.qrCodeImage || j.qr || j.qrImage || j.image || j.data?.pngBase64 || null;

        if (emv) {
          $("#emv").textContent = emv;
          $("#emv").style.display = "block";
          $("#copyBtn").style.display = "inline-block";
          $("#copyBtn").onclick = () => {
            navigator.clipboard.writeText(emv).then(()=>{
              $("#copyBtn").textContent = "COPIADO!";
              setTimeout(()=>$("#copyBtn").textContent="COPIAR CHAVE",2000);
            });
          };
        } else {
          $("#emv").style.display = "none";
          $("#copyBtn").style.display = "none";
        }

        if (qrImg) {
          $("#qr").src = qrImg.startsWith("data:") ? qrImg : `data:image/png;base64,${qrImg}`;
          $("#qr").style.display = "block";
        } else {
          $("#qr").style.display = "none";
        }

        $("#status").textContent = "Status: " + (j.status || "created");
      }catch(err){
        $("#status").textContent = "Erro: " + err.message;
        $("#qr").style.display = "none";
        $("#emv").style.display = "none";
        $("#copyBtn").style.display = "none";
      }finally{
        setUI({loading:false});
      }
    }

    function setUI({loading}){
      const btn = $("#btn");
      if (loading){
        $("#status").textContent = "Gerando cobrança PIX...";
        btn.setAttribute("disabled", "disabled");
      } else {
        btn.removeAttribute("disabled");
      }
    }

    // Tecla "s" → consultar status (1x por minuto)
    document.addEventListener("keydown", async e => {
      if (e.key !== "s" || !currentId) return;
      const now = Date.now();
      if (now - lastCheck < 60000) return alert("1 consulta por minuto");
      lastCheck = now;
      const r = await fetch("/api/status?id=" + encodeURIComponent(currentId));
      const j = await r.json();
      $("#status").textContent = "Status: " + (j?.status || "desconhecido");
    });
  </script>
</body>
</html>
